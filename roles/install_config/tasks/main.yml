---
- name: read pull-secret.txt
  set_fact:
    pull_secret: "{{ lookup('file', 'pull-secret.json') }}"

- name: update pull-secret with local registry credentials
  set_fact:
    pull_secret: >-
      {{
        pull_secret | combine({
          "auths": {
            "provisioner.cnv.massopen.cloud:5000": {
              "auth": "{}:{}".format(os_registry_user, os_registry_password) | b64encode,
              "email": "lars@redhat.com"
            }
          }
        }, recursive=true)
      }}

- name: ensure clusterconfigs directory exists
  file:
    path: /home/kni/clusterconfigs
    state: directory

- name: create install-config.yaml
  template:
    src: install-config.yaml
    dest: /home/kni/clusterconfigs/install-config.yaml

- name: create hardlink to install-config.yaml
  file:
    path: /home/kni/install-config.yaml
    state: hard
    src: /home/kni/clusterconfigs/install-config.yaml
    force: true

- name: create manifests
  command: >-
    /usr/local/bin/openshift-baremetal-install --dir ~/clusterconfigs create manifests
  args:
    creates: /home/kni/clusterconfigs/manifests

- name: create ignition configs
  command: >-
    /usr/local/bin/openshift-baremetal-install --dir ~/clusterconfigs create ignition-configs
  args:
    creates: /home/kni/clusterconfigs/bootstrap.ign

- name: create baremetal interface config
  delegate_to: localhost
  template:
    src: ifcfg-baremetal
    dest: ./ifcfg-baremetal

- name: base64 encode baremetal interface config
  set_fact:
    ifcfg_baremetal: "{{ lookup('pipe', 'base64 -w0 ifcfg-baremetal') }}"

- name: create ipmi route config
  delegate_to: localhost
  copy:
    content: |
      {% for gw in os_ipmi_gw %}
      ADDRESS{{loop.index0}}={{ os_ipmi_cidr|ipaddr('network') }}
      NETMASK{{ loop.index0 }}={{ os_ipmi_cidr|ipaddr('netmask') }}
      GATEWAY{{ loop.index0 }}={{ gw }}
      {% endfor %}
    dest: ./route-baremetal

- name: base64 encode baremetal route config
  set_fact:
    route_baremetal: "{{ lookup('pipe', 'base64 -w0 route-baremetal') }}"

- name: generate ignition stanzas
  set_fact:
    ignition_ifcfg_baremetal:
      filesystem: root
      path: /etc/sysconfig/network-scripts/ifcfg-baremetal
      contents:
        verification: {}
        source: >-
          data:text/plain;charset=utf-8;base64,{{ ifcfg_baremetal }}
      mode: 420
    ignition_route_baremetal:
      filesystem: root
      path: /etc/sysconfig/network-scripts/route-baremetal
      contents:
        verification: {}
        source: >-
          data:text/plain;charset=utf-8;base64,{{ route_baremetal }}
      mode: 420

- name: write ifcfg stanza
  copy:
    content: "{{ ignition_ifcfg_baremetal | to_nice_json }}"
    dest: /home/kni/ignition_ifcfg_baremetal.json

- name: write route stanza
  copy:
    content: "{{ ignition_route_baremetal | to_nice_json }}"
    dest: /home/kni/ignition_route_baremetal.json

# This is, frankly, ridiculous
- name: create updated ignition configuration
  command: >-
    jq -s '
    .[1] as $ifcfg
    | .[2] as $route
    | .[0]
    | .storage.files[.storage.files|length]
    |= . + $ifcfg
    | .storage.files[.storage.files|length]
    |= . + $route
    '
    /home/kni/clusterconfigs/bootstrap.ign
    /home/kni/ignition_ifcfg_baremetal.json
    /home/kni/ignition_route_baremetal.json
  register: ign_bootstrap

- name: replace ignition configuration
  copy:
    content: "{{ ign_bootstrap.stdout }}"
    dest: /home/kni/clusterconfigs/bootstrap.ign
