---
- name: read pull-secret.txt
  set_fact:
    pull_secret: "{{ lookup('file', 'pull-secret.json') }}"

- name: update pull-secret with local registry credentials
  set_fact:
    pull_secret: >-
      {{
        pull_secret | combine({
          "auths": {
            "provisioner.cnv.massopen.cloud:5000": {
              "auth": "{}:{}".format(os_registry_user, os_registry_password) | b64encode,
              "email": "lars@redhat.com"
            }
          }
        }, recursive=true)
      }}

- name: ensure clusterconfigs directory exists
  file:
    path: /home/kni/clusterconfigs
    state: directory

- name: create install-config.yaml
  template:
    src: install-config.yaml
    dest: /home/kni/clusterconfigs/install-config.yaml

- name: create hardlink to install-config.yaml
  file:
    path: /home/kni/install-config.yaml
    state: hard
    src: /home/kni/clusterconfigs/install-config.yaml
    force: true

- name: create manifests
  command: >-
    /usr/local/bin/openshift-baremetal-install --dir ~/clusterconfigs create manifests
  args:
    creates: /home/kni/clusterconfigs/manifests
