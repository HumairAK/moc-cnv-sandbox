---
- hosts: provisioner
  become: true
  tags: [fetch]
  tasks:
    # Save a copy of the generated install-config.yaml file for
    # diagnostic/debugging purposes.
    - name: get install-config
      fetch:
        src: /home/kni/install-config.yaml
        dest: cluster/install-config.yaml
        flat: true

    # Fetch the kubeconfig file
    - name: get kubeconfig
      fetch:
        src: /home/kni/clusterconfigs/auth/kubeconfig
        dest: cluster/kubeconfig
        flat: true

    # Fetch the kubeadmin password
    - name: get kubeadmin password
      fetch:
        src: /home/kni/clusterconfigs/auth/kubeadmin-password
        dest: cluster/kubeadmin-password
        flat: true

- hosts: localhost
  tags: [ocp]
  environment:
    KUBECONFIG: ./cluster/kubeconfig
  roles:
    # Block openshift hosts from ilana's cluster, working around
    # substring matching issue in openshift 4.4.x.
    - role: ocp/firewall
      tags: [firewall]

    # Set up the default ingress certificate (used e.g. for the 
    # openshift web ui).
    - role: ocp/default-ingress-certificate
      tags: [tls]

    # Connect OpenShift to the MOC SSO environment.
    - role: ocp/moc-sso
      tags: [sso]

    # Configure authorization. In particular, ensure that automatically
    # created users cannot create projects until after they have been
    # added to the approved-users group.
    - role: ocp/authz
      tags: [authz]

    # Install CNV operator.
    - role: ocp/cnv
      tags: [cnv]

    # Configure bridge to permit CNV VMs to connect directly to
    # baremetal network.
    - role: ocp/public-net
      tags: net

    # Install and configure Local Storage Operator.
    - role: ocp/lso
      tags: [lso]

    # Configure the hostpath provisioner.
    - role: ocp/hostpath
      tags: [hostpath]
